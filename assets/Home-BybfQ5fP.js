import{w as F,j as e,a0 as C,f as i,aa as M,F as K,a2 as R,ak as Q,a6 as y,au as N,U as j,av as k,aj as _,W as O,a5 as L,al as H,aw as $,ax as E,a1 as Y,ay as ee}from"./index-CeIe-P89.js";import{u as te,S as ne}from"./index-CC5aZMLV.js";import{T as oe,a as D,B as se,m as w,b as ae,D as re,I as le,C as ie,c as ce,S as W,u as ue,P as de,v as G}from"./App-BhD2WLvn.js";import{S as ge}from"./Star-B9IEFfvP.js";import{N as xe,B as pe,D as fe}from"./NoticeCard-C7_JkrlG.js";import{c as A,e as U}from"./mapStyle-cDsFuGbO.js";import{D as me}from"./DialogTitle-UD454GAM.js";import{S as he}from"./Slider-BUHjFv8y.js";import{T as be,a as Z}from"./ToggleButtonGroup-DDTiW2Th.js";import{t as ye}from"./index-KDuatPdx.js";const je=F(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),Ce=F(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),ve=F(e.jsx("path",{d:"M21 3 3 10.53v.98l6.84 2.65L12.48 21h.98z"}),"NearMe"),Re=({homeTab:t,onChangeTab:r})=>{const{t:s}=C(),{collections:l}=i.useContext(M);return te(),e.jsxs(oe,{value:t,onChange:(d,u)=>r(u,!0),sx:Te,variant:"scrollable",scrollButtons:!0,allowScrollButtonsMobile:!0,children:[e.jsx(D,{iconPosition:"start",icon:e.jsx(ve,{}),label:s("附近"),value:"nearby",disableRipple:!0}),e.jsx(D,{iconPosition:"start",icon:e.jsx(ge,{}),label:s("常用"),value:"saved",disableRipple:!0}),e.jsx(D,{iconPosition:"start",icon:e.jsx(se,{}),label:s("Collections"),value:"collections",disableRipple:!0}),l.map((d,u)=>e.jsx(D,{label:d.name,value:d.name,disableRipple:!0},`collection-${u}`))]})},Se=(t,r)=>{if(t==="saved"||t==="nearby"||t==="collections")return!0;for(let s=0;s<r.length;++s)if(t===r[s].name)return!0;return!1},Te={background:t=>t.palette.background.default,minHeight:"36px","& .MuiTab-root":{textTransform:"none",alignItems:"center",justifyContent:"center",paddingTop:0,paddingBottom:0,minHeight:"32px"},"& .MuiTabs-flexContainer":{justifyContent:"flex-start","& svg":{fontSize:"1rem"},"& .MuiTab-root":{fontSize:"0.8em"}}};function S(t,r,s=64){const l=[],u=t.lat*Math.PI/180;for(let a=0;a<=s;a++){const c=a*2*Math.PI/s,n=r*Math.cos(c),m=r*Math.sin(c)/6378137,f=n/(6378137*Math.cos(u));l.push([t.lng+f*180/Math.PI,t.lat+m*180/Math.PI])}return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[l]}}}const Me=K.forwardRef(({range:t,value:r,onChange:s},l)=>{const d=i.useRef(null),u=i.useRef(r).current,{colorMode:a,mapStyleType:c}=i.useContext(R),[n,g]=i.useState(null),m=i.useRef(null);i.useImperativeHandle(l,()=>n,[n]);const f=i.useCallback(()=>{if(n===null)return;const o=n.getCenter(),p={lat:o.lat,lng:o.lng};d.current&&d.current.setLngLat([o.lng,o.lat]);const x=n.getSource("range-circle");x&&x.setData(S(o,t)),s(p)},[s,n,t]);return i.useEffect(()=>{if(!m.current)return;const o=new w.Map({container:m.current,style:A(a,c),center:[u.lng,u.lat],zoom:14,pitch:0,maxPitch:0,minZoom:0,maxZoom:22});return o.addControl(new w.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0})),o.addControl(new w.NavigationControl({visualizePitch:!0,visualizeRoll:!0,showZoom:!0,showCompass:!0})),o.on("load",async()=>{o.addSource("range-circle",{type:"geojson",data:S(u,t)}),o.addLayer({id:"range-circle-layer",type:"fill",source:"range-circle",paint:{"fill-color":"#3887be","fill-opacity":.3,"fill-outline-color":"#3887be"}}),c==="raster"&&await U(o,a),g(o)}),()=>{o.remove(),g(null)}},[]),i.useEffect(()=>{if(!n)return;const o=document.createElement("div");return o.style.width="30px",o.style.height="30px",o.style.backgroundImage="url(https://unpkg.com/leaflet@1.0.1/dist/images/marker-icon-2x.png)",o.style.backgroundSize="contain",o.style.backgroundRepeat="no-repeat",d.current=new ae.Marker({element:o,anchor:"bottom"}).setLngLat([u.lng,u.lat]).addTo(n),()=>{d.current&&(d.current.remove(),d.current=null)}},[n]),i.useEffect(()=>{if(!n)return;const{lat:o,lng:p}=r,x=n.getCenter();if((x.lat!==o||x.lng!==p)&&n.setCenter([p,o]),d.current){const b=d.current.getLngLat();(b.lat!==o||b.lng!==p)&&d.current.setLngLat([p,o])}const h=n.getSource("range-circle");h&&h.setData(S({lat:o,lng:p},t))},[n,t,r.lat,r.lng]),i.useEffect(()=>{if(n)return n.on("move",f),()=>{n.off("move",f)}},[f,n]),i.useEffect(()=>{if(!n)return;const o=n.getSource("range-circle"),p=n.getCenter();o&&o.setData(S({lat:p.lat,lng:p.lng},t));const x=new w.LngLatBounds;S({lat:p.lat,lng:p.lng},t).geometry.coordinates[0].forEach(([b,B])=>x.extend([b,B])),n.fitBounds(x,{padding:50,animate:!1})},[n,t]),i.useEffect(()=>{if(!n)return;const o=p=>{const x={lat:p.lngLat.lat,lng:p.lngLat.lng};n.setCenter([x.lng,x.lat]),s(x)};return n.on("click",o),()=>{n.off("click",o)}},[n,s]),i.useEffect(()=>{if(!n)return;const o=A(a,c);n.setStyle(o);const p=()=>{const x=n.getCenter();n.getSource("range-circle")||n.addSource("range-circle",{type:"geojson",data:S({lat:x.lat,lng:x.lng},t)}),n.getLayer("range-circle-layer")||n.addLayer({id:"range-circle-layer",type:"fill",source:"range-circle",paint:{"fill-color":"#3887be","fill-opacity":.3,"fill-outline-color":"#3887be"}}),c==="raster"&&U(n,a)};return n.once("styledata",p),()=>{n.off("styledata",p)}},[a,c,n,t]),e.jsx("div",{style:{height:"100%",position:"relative"},children:e.jsx("div",{ref:m,style:{height:"100%",width:"100%"}})})}),Le=({open:t,onClose:r})=>{const{geolocation:s,manualGeolocation:l,searchRange:d,setManualGeolocation:u,setSearchRange:a}=i.useContext(R),{t:c}=C(),[n,g]=i.useState({geolocation:l??s.current,searchRange:d}),m=i.useCallback(()=>{u(n.geolocation),a(n.searchRange),r()},[n,u,a,r]),f=i.useCallback(x=>{g(h=>({...h,geolocation:x}))},[]),o=i.useCallback(x=>{g(h=>({...h,searchRange:x}))},[]),p=i.useCallback(x=>{const{distance:h,unit:b}=Q(x);return`${h}${c(b)}`},[c]);return e.jsxs(re,{open:t,onClose:m,sx:ke,children:[e.jsxs(me,{sx:De,children:[c("自訂搜尋範圍"),e.jsx(le,{onClick:m,children:e.jsx(ie,{})})]}),e.jsxs(ce,{children:[e.jsx(Me,{range:n.searchRange,value:n.geolocation,onChange:f}),e.jsx(y,{sx:{px:4,py:5},children:e.jsx(he,{sx:we,"aria-label":"Range",value:P(n.searchRange,I,v),valueLabelDisplay:"on",marks:v.map((x,h)=>({label:p(I[h]),value:x})),min:v[0],max:v[v.length-1],step:250,scale:x=>P(x,v,I),valueLabelFormat:x=>p(x),onChange:(x,h)=>o(P(h,v,I))})})]})]})},ke={"& .MuiPaper-root":{width:"100%",height:"calc(100dvh - 100px)"},"& .MuiDialogContent-root":{p:0,display:"flex",flexDirection:"column"}},De={backgroundColor:t=>t.palette.background.default,color:t=>t.palette.primary.main,display:"flex",justifyContent:"space-between"},we={"& .MuiSlider-mark":{backgroundColor:"#bfbfbf",height:8}},v=[0,1e3,2e3,3e3,4e3,5e3],I=[20,100,200,400,2e3,4e3],P=(t,r,s)=>{if(t<=r[0])return s[0];for(let l=1;l<r.length;++l)if(t<=r[l])return s[l-1]+(t-r[l-1])*(s[l]-s[l-1])/(r[l]-r[l-1]);return s[s.length-1]},Ie=()=>{const{t}=C(),{searchRange:r,setSearchRange:s}=i.useContext(R),[l,d]=i.useState(!1);return e.jsxs(y,{sx:He,children:[e.jsxs(j,{variant:"caption",children:[t("搜尋範圍（米）"),":"]}),e.jsxs(be,{value:k.includes(r)?r:"custom",onChange:(u,a)=>{k.includes(a)?s(a):d(!0)},"aria-label":"search range",size:"small",exclusive:!0,children:[k.map(u=>{const{distance:a}=Q(u);return e.jsx(Z,{sx:V,disableRipple:!0,value:u,"aria-label":u.toString(),children:a},`range-${u}`)}),e.jsxs(Z,{sx:V,disableRipple:!0,value:"custom","aria-label":"custom",children:[t("自訂"),!k.includes(r)&&`(${r})`]},"range-custom")]}),e.jsx(Le,{open:l,onClose:()=>d(!1)})]})},He={position:"sticky",top:0,display:"flex",justifyContent:"space-around",alignItems:"center",flexWrap:"wrap",listStyle:"none",px:0,py:1,m:0,borderRadius:0,fontSize:14,borderBottomWidth:1,borderBottomColor:t=>t.palette.mode==="dark"?N[900]:N[200],borderBottomStyle:"solid"},V={height:30,px:2},X=({name:t,routeStrings:r,defaultExpanded:s=!0})=>{const[l,d]=i.useState(s),u=i.useMemo(()=>r.split("|").filter(a=>a)??[],[r]);return u.length===0?e.jsx(e.Fragment,{}):e.jsxs(y,{children:[e.jsxs(y,{sx:Ee,onClick:()=>d(a=>!a),children:[e.jsx(j,{variant:"body1",m:1,fontWeight:700,children:t}),e.jsx(y,{children:l?e.jsx(je,{}):e.jsx(Ce,{})})]}),e.jsx(_,{}),l&&e.jsx(O,{disablePadding:!0,children:u.map((a,c)=>!!a&&e.jsx(W,{routeId:a},`route-${t}-${c}`))}),e.jsx(_,{})]})},Ee={display:"flex",alignItems:"center",justifyContent:"space-between",mx:1,cursor:"pointer"},Be=({isFocus:t})=>{const{t:r}=C(),{manualGeolocation:s,geolocation:l,isRouteFilter:d,searchRange:u}=i.useContext(R),{db:{routeList:a,stopList:c,serviceDayMap:n},isTodayHoliday:g}=i.useContext(L),[m,f]=i.useState(s??l.current),o=i.useMemo(()=>ye(h=>{f(h)},500),[]);i.useEffect(()=>{const h=setInterval(()=>{o(s??l.current)},1e3);return o(s??l.current),()=>{clearInterval(h)}},[s,l,o]);const p=i.useMemo(()=>$e({geolocation:m,stopList:c,routeList:a,isRouteFilter:d,isTodayHoliday:g,serviceDayMap:n,searchRange:u}),[m,c,a,d,g,n,u]),x=i.useMemo(()=>Object.values(p).map(h=>h.split("|").every(b=>b==="")).every(Boolean),[p]);return t?x?e.jsx(y,{sx:q,children:e.jsx(j,{sx:{marginTop:5},fontWeight:"700",children:r("附近未有任何路線")})}):e.jsx(y,{sx:q,children:Object.entries(p).map(([h,b])=>e.jsx(X,{name:r(h),routeStrings:b},`nearby-${h}`))}):e.jsx(e.Fragment,{})},$e=({geolocation:t,stopList:r,routeList:s,isRouteFilter:l,isTodayHoliday:d,serviceDayMap:u,searchRange:a})=>{const c=[],n=Object.entries(r).map(g=>[...g,H(g[1].location,t)]).filter(g=>g[2]<a).sort((g,m)=>g[2]-m[2]).slice(0,200).reduce((g,[m])=>(Object.entries(s).forEach(([f,o])=>{["kmb","lrtfeeder","lightRail","gmb","ctb","nlb"].forEach(p=>{o.stops[p]&&o.stops[p].includes(m)&&(g[$[p]]===void 0&&(g[$[p]]=[]),c.find(([x,h,b])=>x==o.route&&h==p&&b<o.serviceType)===void 0&&(g[$[p]].push(f+"/"+o.stops[p].indexOf(m)),c.push([o.route,p,o.serviceType])))})}),g),{bus:[],mtr:[],lightRail:[],minibus:[],ferry:[]});return Object.entries(n).reduce((g,[m,f])=>(g[m]=E(f,d,l,s,r,u,t),g),{})},q={display:"flex",flexDirection:"column",gap:2,flex:1,minHeight:"100dvh"},Pe=({isFocus:t})=>{const{t:r}=C(),{geolocation:s,isRouteFilter:l}=i.useContext(R),{savedEtas:d}=i.useContext(M),{db:{routeList:u,stopList:a,serviceDayMap:c},isTodayHoliday:n}=i.useContext(L),g=i.useMemo(()=>Fe({savedEtas:d,geolocation:s.current,stopList:a,routeList:u,isRouteFilter:l,isTodayHoliday:n,serviceDayMap:c}),[d,s,u,a,l,n,c]),m=i.useMemo(()=>g.every(f=>!f),[g]);return t?m?e.jsx(y,{sx:Oe,children:e.jsx(j,{sx:{marginTop:5},fontWeight:"700",children:r("未有收藏路線")})}):e.jsx(O,{disablePadding:!0,sx:{minHeight:"100dvh"},children:g.map((f,o)=>!!f&&e.jsx(W,{routeId:f},`route-shortcut-${o}`))}):e.jsx(e.Fragment,{})},Fe=({savedEtas:t,geolocation:r,stopList:s,routeList:l,isRouteFilter:d,isTodayHoliday:u,serviceDayMap:a})=>E(t.filter((c,n,g)=>g.indexOf(c)===n&&c.split("/")[0]in l).map((c,n,g)=>{const[m,f]=c.split("/"),o=Object.values(l[m].stops).sort((p,x)=>x.length-p.length)[0];if(f!==void 0&&parseInt(f,10)<o.length)return[c,H(r,s[o[Number(f)]].location),g.length-n];{const p=o.map(x=>[x,H(r,s[x].location)]).sort(([,x],[,h])=>x<h?-1:1)[0][0];return[c,H(r,s[p].location),g.length-n]}}).sort((c,n)=>c[2]-n[2]).map(c=>c[0]).slice(0,40).reverse(),u,d,l,s,a,r).split("|"),Oe={display:"flex",flexDirection:"column",gap:2,flex:1,minHeight:"100dvh"},We=({isFocus:t})=>{const{t:r}=C(),{geolocation:s,isRouteFilter:l}=i.useContext(R),{collections:d}=i.useContext(M),{db:{routeList:u,stopList:a,serviceDayMap:c},isTodayHoliday:n}=i.useContext(L),g=i.useMemo(()=>ze({collections:d,geolocation:s.current,stopList:a,routeList:u,isRouteFilter:l,isTodayHoliday:n,serviceDayMap:c}),[d,s,a,u,l,n,c]);return t?g.length===0?e.jsx(y,{sx:J,children:e.jsx(j,{sx:{marginTop:5},fontWeight:700,children:r("未有收藏路線")})}):e.jsxs(y,{sx:J,children:[g.map(({name:m,routes:f,defaultExpanded:o},p)=>e.jsx(X,{name:m,routeStrings:f,defaultExpanded:o},`collection-${p}`)),!g.reduce((m,{routes:f})=>m||f.split("|").filter(o=>!!o).length>0,!1)&&e.jsx(j,{sx:{marginTop:5},fontWeight:700,children:r("未有收藏路線")})]}):e.jsx(e.Fragment,{})},ze=({collections:t,geolocation:r,stopList:s,routeList:l,isRouteFilter:d,isTodayHoliday:u,serviceDayMap:a})=>t.map(({name:c,list:n,schedules:g})=>({name:c,routes:n,defaultExpanded:g.reduce((m,{day:f,start:o,end:p})=>{if(m)return m;const x=new Date;x.setUTCHours(x.getUTCHours()+8);const h=x.getUTCDay();if(u&&f===-1||f===h){let b=o.hour*60+o.minute,B=p.hour*60+p.minute,z=(x.getUTCHours()*60+x.getUTCMinutes())%1440;return b<=z&&z<=B}return!1},!1)})).map(c=>({...c,routes:E(c.routes,u,d,l,s,a,r)})),J={display:"flex",flexDirection:"column",gap:2,minHeight:"100dvh"},Ne=({collection:t,isFocus:r})=>{const{t:s}=C(),{geolocation:l,isRouteFilter:d}=i.useContext(R),{db:{routeList:u,stopList:a,serviceDayMap:c},isTodayHoliday:n}=i.useContext(L),g=i.useMemo(()=>_e({savedEtas:t.list,geolocation:l.current,stopList:a,routeList:u,isRouteFilter:d,isTodayHoliday:n,serviceDayMap:c}),[t,l,a,u,d,n,c]),m=i.useMemo(()=>g.every(f=>!f),[g]);return r?m?e.jsx(y,{sx:Ge,children:e.jsx(j,{sx:{marginTop:5},fontWeight:700,children:e.jsx("b",{children:s("收藏中未有路線")})})}):e.jsx(O,{disablePadding:!0,sx:{minHeight:"100dvh"},children:g.map((f,o)=>!!f&&e.jsx(W,{routeId:f},`route-shortcut-${o}`))}):e.jsx(e.Fragment,{})},_e=({savedEtas:t,geolocation:r,stopList:s,routeList:l,isRouteFilter:d,isTodayHoliday:u,serviceDayMap:a})=>E(t,u,d,l,s,a,r).split("|"),Ge={display:"flex",flexDirection:"column",gap:2,flex:1,minHeight:"100dvh"},Ae=K.forwardRef(({homeTab:t,onChangeTab:r},s)=>{const{collections:l}=i.useContext(M),d=i.useRef(t);i.useImperativeHandle(s,()=>({changeTab:a=>{d.current=a}}));const u=i.useCallback(()=>{let a=T.indexOf(d.current);if(a!==-1)return a;for(let c=0;c<l.length;++c)if(l[c].name===d.current)return c+T.length;return-1},[l]);return e.jsxs(e.Fragment,{children:[t==="nearby"?e.jsx(Ie,{}):null,e.jsxs(ne,{index:u(),onChangeIndex:a=>{r(a<T.length?T[a]:l[a-T.length].name)},children:[e.jsx(Be,{isFocus:t==="nearby"}),e.jsx(Pe,{isFocus:t==="saved"}),e.jsx(We,{isFocus:t==="collections"}),l.map(a=>e.jsx(Ne,{collection:a,isFocus:t===a.name},`list-${a.name}`))]})]})}),T=["nearby","saved","collections"],nt=()=>{const{AppTitle:t}=i.useContext(L),{collections:r}=i.useContext(M),{t:s}=C(),l=Y(),{collectionName:d}=ue(),u=i.useRef(null),a=d??localStorage.getItem("homeTab"),[c,n]=i.useState(Se(a,r)?a:"nearby");i.useEffect(()=>{ee({title:`${s("Dashboard")} - ${s(t)}`,description:s("home-page-description"),lang:l})},[l,t,s]);const g=(m,f=!1)=>{n(m),localStorage.setItem("homeTab",m),u.current&&f&&u.current.changeTab(m)};return e.jsxs(de,{sx:Ue,square:!0,elevation:0,children:[e.jsx(j,{component:"h1",style:G,children:`${s("Dashboard")} - ${s(t)}`}),e.jsx(j,{component:"h2",style:G,children:s("home-page-description")}),e.jsx(Re,{homeTab:c,onChangeTab:g}),e.jsx(xe,{}),e.jsx(pe,{}),e.jsx(fe,{}),e.jsx(Ae,{ref:u,homeTab:c,onChangeTab:g})]})},Ue={background:t=>t.palette.mode==="dark"?t.palette.background.default:"white",textAlign:"center",display:"flex",flexDirection:"column",overflow:"auto",width:"100%",height:"100%"};export{nt as default};
