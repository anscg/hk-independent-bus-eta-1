import{w as K,j as M,f as a,a2 as T,a6 as Z,a5 as N,aY as j,bb as H,aX as W}from"./index-CeIe-P89.js";import"./index-KDuatPdx.js";import{b as q,m as z}from"./App-BhD2WLvn.js";import{c as P,e as A}from"./mapStyle-cDsFuGbO.js";const J=K(M.jsx("path",{d:"M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m2.19 12.19L6 18l3.81-8.19L18 6z"}),"Explore"),U=()=>{const o=Promise.resolve("granted");return B&&typeof DeviceOrientationEvent<"u"&&typeof(DeviceOrientationEvent==null?void 0:DeviceOrientationEvent.requestPermission)=="function"?DeviceOrientationEvent.requestPermission():o},B=(()=>{try{return!!(navigator&&navigator.userAgent&&navigator.userAgent.includes("Safari/")&&!(navigator.userAgent.includes("Chrome/")||navigator.userAgent.includes("Chromium/")))}catch{return!1}})(),X=()=>{const{compassPermission:o,setCompassPermission:g}=a.useContext(T),e=a.useCallback(()=>{U().then(r=>{g(r)})},[g]);return!B||o==="granted"?M.jsx(M.Fragment,{}):M.jsx(Z,{sx:Y,onClick:e,children:M.jsx(J,{sx:{p:"3px",color:"black"}})})},Y={position:"absolute",bottom:57,right:5,background:"white",width:32,height:32,display:"flex",justifyContent:"center",alignItems:"center",borderRadius:"4px",boxShadow:"0 0 0 2px rgba(0,0,0,0.1)",cursor:"pointer",zIndex:1},Q=(o,g)=>{const[e,r]=a.useState(null),{db:{routeList:s}}=a.useContext(N),{gtfsId:l,bound:f,co:m,route:b,dest:u}=s[o];return a.useEffect(()=>{let t="";return l?t=`${l}-${f[m[0]]==="I"?"I":"O"}.json`:m.includes("mtr")?t=`${o.split("-")[0].toLowerCase()}.json`:b&&m.includes("lightRail")&&(t=`${b}${u.en.includes("Circular")?"":f[m[0]]==="I"?"_I":"_O"}.json`),fetch(`https://hkbus.github.io/route-waypoints/${t}`).then(d=>d.json()).then(d=>{r(d)}).catch(()=>{r({features:[{type:"Feature",geometry:{type:"LineString",coordinates:g.reduce((d,{location:{lat:p,lng:C}})=>(d.push([C,p]),d),[])}}],type:"FeatureCollection"})}),()=>{r(null)}},[o,l,f,m,g,u,b]),e},V=({map:o})=>{const[g,e]=a.useState([]),r=a.useRef({}),[s,l]=a.useState(14);return a.useEffect(()=>{fetch("https://data.hkbus.app/exits.mtr.json").then(f=>f.json()).then(f=>e(f))},[]),a.useEffect(()=>{if(!o||!g.length)return;const f=()=>{const m=o.getBounds(),b=o.getZoom();l(b),Object.keys(r.current).forEach(u=>{g.find(t=>t.exit===u)||(r.current[u].remove(),delete r.current[u])}),g.forEach(u=>{if(!r.current[u.exit]){const d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center",d.style.pointerEvents="auto";const p=document.createElement("img");p.src="/img/HK_MTR_logo.svg",p.alt="MTR Exit",p.style.width="15px",p.style.height="15px",p.style.display="block",d.appendChild(p),d.title=u.name.en+(u.barrierFree?" (Barrier-free)":"");const C=new q.Marker({element:d,anchor:"bottom"}).setLngLat([u.lng,u.lat]);r.current[u.exit]=C}const t=r.current[u.exit];t.setLngLat([u.lng,u.lat]),b>=16&&m.contains({lng:u.lng,lat:u.lat})?t.getElement().parentNode||t.addTo(o):t.remove()})};return f(),o.on("move",f),o.on("zoom",f),()=>{o.off("move",f),o.off("zoom",f),Object.values(r.current).forEach(m=>m.remove())}},[o,g]),null};function I(o,g){let e=o.replace("#","");e.length===3&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);const r=parseInt(e,16);let s=r>>16&255,l=r>>8&255,f=r&255;return s=Math.max(0,Math.floor(s*(1-g))),l=Math.max(0,Math.floor(l*(1-g))),f=Math.max(0,Math.floor(f*(1-g))),`#${((1<<24)+(s<<16)+(l<<8)+f).toString(16).slice(1)}`}const ae=({routeId:o,stopIds:g,stopIdx:e,route:r,companies:s,onMarkerClick:l})=>{const{geolocation:f,colorMode:m,mapStyleType:b}=a.useContext(T),{db:{stopList:u}}=a.useContext(N),[t,d]=a.useState(null),p=a.useRef(null),C=a.useRef([]),c=a.useMemo(()=>g.map(n=>u[n]),[u,g]),x=Q(o,c),y=a.useRef({initialCenter:c[e]?c[e].location:j(),currentStopCenter:c[e]?c[e].location:j(),center:c[e]?c[e].location:j(),isFollow:!1,stops:c,stopIdx:e}),D=a.useRef(`${m}-${b}`);a.useEffect(()=>{if(!p.current)return;const n=c[e]?c[e].location:j(),i=new z.Map({container:p.current,style:P(m,b),center:[n.lng,n.lat],zoom:16,minZoom:0,maxZoom:22});return i.addControl(new z.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0})),i.addControl(new z.NavigationControl({visualizePitch:!0,visualizeRoll:!0,showZoom:!0,showCompass:!0})),i.on("load",async()=>{d(i),b==="raster"&&await A(i,m)}),()=>{i.remove(),d(null)}},[]),a.useEffect(()=>{if(!t)return;let n,i;y.current.stops!==c||y.current.stopIdx!==e?n=!1:n=y.current.isFollow,y.current.stops===c&&y.current.stopIdx===e&&n?i=f.current:i=c[e]?c[e].location:j();const k=y.current.center;k!==i&&!H(i,k)&&(y.current.stops!==c?t.setCenter([i.lng,i.lat]):t.flyTo({center:[i.lng,i.lat]})),y.current={...y.current,center:i,currentStopCenter:c[e]?c[e].location:j(),stops:c,stopIdx:e,isFollow:n}},[c,e,f,t]),a.useEffect(()=>{if(!t)return;y.current={...y.current,map:t};const n=()=>{y.current={...y.current,center:y.current.currentStopCenter,isFollow:!1}};return t.on("dragend",n),t.on("dragstart",n),()=>{t.off("dragstart",n),t.off("dragend",n)}},[t]);const L=a.useCallback((n,i,k,O)=>{var F;if(!((F=i==null?void 0:i.features)!=null&&F.length))return;const $="route-path",S="route-path-border",E="route-path-line";n.getLayer(E)&&n.removeLayer(E),n.getLayer(S)&&n.removeLayer(S),n.getSource($)&&n.removeSource($),n.addSource($,{type:"geojson",data:i});const w=W(k,O),_=I(w,.4);n.addLayer({id:S,type:"line",source:$,paint:{"line-color":_,"line-width":7},layout:{"line-join":"round","line-cap":"round"}}),n.addLayer({id:E,type:"line",source:$,paint:{"line-color":w,"line-width":4},layout:{"line-join":"round","line-cap":"round"}})},[]),R=a.useCallback((n,i,k,O,$,S)=>{S.current.forEach(E=>E.remove()),S.current=[],i.forEach((E,w)=>{const _=ee({active:w===k,passed:w<k,companies:O}),F=new q.Marker({element:_,anchor:"bottom"}).setLngLat([E.location.lng,E.location.lat]).addTo(n);_.addEventListener("click",G=>{$(w,G)}),S.current.push(F)})},[]);return a.useEffect(()=>{if(t)return L(t,x,s,r),()=>{}},[t,x,s,r,L]),a.useEffect(()=>{if(t)return R(t,c,e,s,l,C),()=>{C.current.forEach(n=>n.remove()),C.current=[]}},[t,c,e,s,l,R]),a.useEffect(()=>{if(!t)return;const n=`${m}-${b}`;if(D.current===n)return;const i=P(m,b);D.current=n,t.setStyle(i);const k=()=>{L(t,x,s,r),R(t,c,e,s,l,C),b==="raster"&&A(t,m)};return t.once("styledata",k),()=>{t.off("styledata",k)}},[m,b,t,x,s,r,c,e,l,L,R]),M.jsxs(Z,{id:"route-map",sx:te,children:[M.jsx("div",{ref:p,className:h.mapContainer}),M.jsx(V,{map:t}),M.jsx(X,{})]})},ee=({active:o,passed:g,companies:e})=>{const r=document.createElement("div");r.style.width="30px",r.style.height="30px",r.style.cursor="pointer";let s=h.marker,l="/img/bus_kmb.svg";return e[0]==="mtr"?(s+=` ${h.mtrMarker}`,l="/img/mtr.svg",r.style.width="20px",r.style.height="20px"):e.includes("lightRail")?(s+=` ${h.mtrMarker}`,l="/img/mtr.svg",r.style.width="20px",r.style.height="20px"):e[0].startsWith("gmb")?(s+=` ${h.gmbMarker}`,l="/img/minibus.svg"):e.includes("lrtfeeder")?(s+=` ${h.lrtfeederMarker}`,l="/img/bus_lrtfeeder.svg"):e.includes("nlb")?(s+=` ${h.nlbMarker}`,l="/img/bus_nlb.svg"):e.includes("ctb")&&e.includes("kmb")?(s+=` ${h.jointlyMarker}`,l="/img/bus_jointly.svg"):e.includes("ctb")?(s+=` ${h.ctbMarker}`,l="/img/bus_ctb.svg"):(s+=` ${h.kmbMarker}`,l="/img/bus_kmb.svg"),o&&(s+=` ${h.active}`),g&&(s+=` ${h.passed}`),r.className=s,r.style.backgroundImage=`url(${l})`,r.style.backgroundSize="contain",r.style.backgroundRepeat="no-repeat",r.style.backgroundPosition="center",r},v="map",h={mapContainer:`${v}-mapContainer`,marker:`${v}-marker`,mtrMarker:`${v}-mtrMarker`,gmbMarker:`${v}-gmbMarker`,ctbMarker:`${v}-ctbMarker`,jointlyMarker:`${v}-jointlyMarker`,lrtfeederMarker:`${v}-lrtfeederMarker`,nlbMarker:`${v}-nlbMarker`,kmbMarker:`${v}-kmbMarker`,active:`${v}-active`,passed:`${v}-passed`},te={height:"35vh",position:"relative",filter:o=>o.palette.mode==="dark"?"brightness(0.8)":"none",[`& .${h.mapContainer}`]:{height:"35vh",width:"100%"},[`& .${h.active}`]:{animation:"blinker 1.5s infinite"},[`& .${h.passed}`]:{filter:"grayscale(100%)"},"& .mtr-exit":{backgroundImage:"url(/img/HK_MTR_logo.svg)"},"& .mtr-exit-label":{background:"transparent",color:"#AC2E44",fontWeight:600},"& .mtr-exit-barrier-free":{backgroundImage:"url(/img/Wheelchair_symbol.svg)",backgroundSize:"12px 11px"}};export{ae as default};
